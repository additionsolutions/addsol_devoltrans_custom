name: Deploy ERPNext Custom App to VPS

on:
  push:
    branches:
      - main # Trigger only when main branch is updated (e.g., after merging dev)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy and Restart Bench
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e

            # --- Load nvm for non-interactive shells ---
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
            nvm use 18

            echo "Node version in CI:"
            node -v
            yarn -v

            echo ">>> Navigating to app folder..."
            cd /home/addsol/frappe-bench/apps/addsol_devoltrans_custom

            echo ">>> Fetching latest code from GitHub..."
            git fetch origin
            git reset --hard origin/main

            echo ">>> Updating Python packages (if any)..."
            cd /home/addsol/frappe-bench
            bench pip install -e apps/addsol_devoltrans_custom --no-cache-dir

            echo ">>> Clear cache"
            bench --site deverp.aitspl.com clear-cache

            echo ">>> Building assets..."
            bench build --app addsol_devoltrans_custom

            echo ">>> Applying migrations..."
            bench --site deverp.aitspl.com migrate

            echo ">>> Restarting all bench processes..."
            bench restart

            echo "âœ… Deployment completed successfully!"
          EOF
